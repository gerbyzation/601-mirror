<!DOCTYPE html>
<html>
    <head>
        <title>Mosaic </title>
        
    </head>
    <body>

<!--    === Webcam ===-->
    <!--<div id="my_camera" style="visibility:hidden"></div>-->
        <div id="my_camera"></div>
        
<!--    === Canvas ===-->
        <canvas id="myCanvas" width="320" height="240" style="border:0px solid #000000;"></canvas>
        <canvas id="displayCanvas" width="1280" height="720" style="position: absolute; top: 0; left: 0;" ></canvas>

<!--    === Webcam script ===-->
        <script type="text/javascript" src="js/webcam.js"></script>
        
<!--    === Webcam script ===-->
        <script type="text/javascript" src='js/socket.io.js'></script>

        <script language="JavaScript">
            var socket = io('https://gerbyzation.nl');
            
            var c = document.getElementById("myCanvas");
            var ctx = c.getContext("2d");
            var pix;
            
            var c2 = document.getElementById("displayCanvas");
            var ctx2 = c2.getContext("2d");

            // number of rows and columns of pixels to take from webcam
            var numberWidth = 30;
            var numberHeight = 30;
            
            console.log("current dimensions:", numberWidth, "x", numberHeight, "y");
            
            var agvColour; 

            // canvas size accordingly
            ctx.canvas.width  = numberWidth;
            ctx.canvas.height = numberHeight;
            
            width = ctx2.canvas.width / numberWidth;
            height = ctx2.canvas.height / numberHeight;
            
            var img = new Image();   // Create new img element
            img.src = 'img/0.jpg'; // Set source path
            
            // array to hold the colour values
            var pixelColour = new Uint8ClampedArray(numberWidth * numberHeight * 4);
            
            var sampleBase64 = "data:image/gif;base64,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";
            
            // this is an example array, will be received from serverside
            // imagearray  [image(set empty) ,colorvalue, Source]
            var imageArray =[, 0, sampleBase64,
                             , 7, "img/7.jpg",
                             , 13, "img/13.jpg",
                             , 27, "img/27.jpg",
                             , 33, "img/33.jpg",
                             , 36, "img/36.jpg",
                             , 40, "img/40.jpg",
                             , 47, "img/47.jpg",
                             , 55, "img/55.jpg",
                             , 60, "img/60.jpg",
                             , 65, "img/65.jpg",
                             , 70, "img/70.jpg",
                             , 80, "img/80.jpg",
                             , 90, "img/80.jpg",
                             , 110, "img/110.jpg"];
            
            // The final imagearray, 128 different color values
            // Each with three entries (colorValue, imageElement, ID)
            var socketImageArray = new Array(128 * 3);

            // var imageArray = socketImageArray
            
            // define images 
            for (var i = 0; i < 45; i +=3) {      
                imageArray[i] = new Image();            // Create new img element
                imageArray[i].src = imageArray[i+2];    // set source to third element in imageArray
            }
            var randomLocation;

            Webcam.set({
                // mirror mode
                flip_horiz: true,

                // live preview size
                width: 320,
                height: 240,

                //// optional settings
//                // device capture size
//                dest_width: 320,
//                dest_height: 240,
//
//                // final cropped size
//                crop_width: 320,
//                crop_height: 240,
//
//                // format and quality
//                image_format: 'jpeg',
//                jpeg_quality: 90
            });

            Webcam.attach( '#my_camera' );

            function loop(){
                requestAnimationFrame(loop);

                // get webcam image
                Webcam.snap( function(data_uri, canvas, context) {
                    // copy image to canvas
                    ctx.drawImage( canvas, 0, 0 , numberWidth, numberHeight);
 
                } );
                
                // Get the CanvasPixelArray 
                var imgd = ctx.getImageData(0, 0, numberWidth, numberHeight);
                pix = imgd.data;

                // Loop over each pixel and store the colour values
                for (var i = 0, n = pix.length; i < n; i += 4) {
                    // colour
                    pixelColour[i  ] = Math.floor( pix[i  ] / 51.1); // red devided and floored to get range 0 > 4
                    pixelColour[i+1] = Math.floor( pix[i+1] / 51.1); // green
                    pixelColour[i+2] = Math.floor( pix[i+2] / 51.1); // blue
                    // i+3 is alpha, we dont need this. Use for greyscale instead
                    
                    // greyscale, only change with enough difference, so that it doesnt hover around single pixel values which causes flickering
                    if (Math.abs(pixelColour[i+3] - Math.floor((pix[i] + pix[i+1] + pix[i+2]) / 6)) > 10){
                        pixelColour[i+3] = Math.floor((pix[i] + pix[i+1] + pix[i+2]) / 6);
                    }
                    
                    
                }
                
                // draw Mosaic webcam
                for (var x = 0; x < numberWidth; x ++) {
                    for (var y = 0; y < numberHeight; y ++) {
                        // 4 bit colours
//                        ctx2.fillStyle = 'rgb(' + pixelColour[(x * 4) + (y * 4 * numberWidth)] * 63 + ',' 
//                                                + pixelColour[(x * 4 + 1) + (y * 4 * numberWidth)] * 63 + ',' 
//                                                + pixelColour[(x * 4 + 2) + (y * 4 * numberWidth)] * 63 + ')';
                        
                        // greyscale
                        agvColour =  pixelColour[(x * 4 + 3) + (y * 4 * numberWidth)];
                        ctx2.fillStyle = 'rgb(' + agvColour * 2 + ',' 
                                                + agvColour * 2 + ',' 
                                                + agvColour * 2 + ')';
                        
                        // draw rectangle if image not found
                        ctx2.fillRect(x * width, y * height, width, height);
                        
                        // start at random location in the array
                        // randomLocation = Math.floor(Math.random(socketImageArray.length / 3));
                        
                        // find matching image from array in a random loop?
//                        for (var i = randomLocation * 3; i != randomLocation * 3; i +=3) {                            
//                            if (agvColour == socketImageArray[i+1]){
//                                ctx2.drawImage( socketImageArray[i] , x * width, y * height, width, height);
//                            }
//                        }   
                        
                        // find matching image from array
                        // for (var i = 0; i < socketImageArray.length; i +=3) {                            
                        //     if (agvColour == socketImageArray[i+1]){
                        if(socketImageArray[agvColour] !== undefined) {
                            ctx2.drawImage(socketImageArray[agvColour].img , x * width, y * height, width, height);
                        }
                        //     }
                        // }        
                    }
                } 
            }
            
            function resize(){
                console.log("Resized");
                ctx2.canvas.width  = window.innerWidth;
                ctx2.canvas.height = window.innerHeight;
                
                width = ctx2.canvas.width / numberWidth;
                height = ctx2.canvas.height / numberHeight;
            }
            
            window.onload = resize, loop();
            window.onresize = resize;
            
            // network setup connection?
            socket.on('connection', function(socket){
                console.log('a user connected');
                
                socket.on('disconnect', function(){
                    console.log('user disconnected');
                });
            });

            // initialise feed script
            socket.on('init_feed', function (data) {
                console.log("init feed", data);
                
                // Assuming data is an array constituting of (colorValue, imageData, ID)
                // Assuming all the data has unique colour values
                /*
                    {
                        color: [int: color[0-128]],
                        id: [uuid],
                        frame: [base64 buffer]
                    }
                */
                // socketImageArray (colorValue, imageElement, ID)
                
                // for (var i = 0; i < data.length; i +=3) {  
                //     socketImageArray[(data.color * 3) + 1] = new Image();          // Create new img element at [colorvalue + 1]
                //     socketImageArray[(data.color * 3) + 1] .src = data.frame;       // set img source to load image
                //     socketImageArray[(data.color * 3) + 2] = data.id;          // set third value to ID from data array
                // }
                    
            });

            // updating feed
            socket.on('image_frame', function (data) {
                console.log('image frame', data);
                
                // Assuming data is an array constituting of (colorValue, imageData, ID)
                // Assuming all the data has unique colour values
                // Assuming only one picture is in this function data
                
                // socketImageArray (colorValue, imageElement, ID)
                
                //data[0] = colorvalue and thus the place in the socketImageArray
                // socketImageArray[(data[0] * 3) + 1] = new Image();          // Create new img element at [colorvalue + 1]
                // socketImageArray[(data[0] * 3) + 1] .src = data[i+1];       // set img source to load image
                // socketImageArray[(data[0] * 3) + 2] = data[i + 2];          // set third value to ID from data array

                // socketImageArray[(data.color * 3) + 1] = new Image();          // Create new img element at [colorvalue + 1]
                // socketImageArray[(data.color * 3) + 1] .src = data.frame;       // set img source to load image
                // socketImageArray[(data.color * 3) + 2] = data.id;          // set third value to ID from data array
                let image = new Image();
                image.src = data.frame;
                socketImageArray[data.color] = {
                    id: data.id,
                    img: image,
                    color: data.color
                }
                
            });
            
        </script>	
    </body>
</html>
